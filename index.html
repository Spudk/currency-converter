<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>송금 통화 비교 계산기 — 저장/초기화 지원</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card-raise{transition:transform .2s ease,box-shadow .2s ease}
    .card-raise:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.12)}
    .chip{border-radius:9999px;padding:.2rem .6rem;border:1px solid rgba(0,0,0,.08);background:#fff}
    .num{font-variant-numeric:tabular-nums}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-sky-50 to-cyan-50">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <!-- HEADER -->
    <header class="flex flex-col md:flex-row gap-4 md:items-center md:justify-between mb-6">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight bg-gradient-to-r from-indigo-600 to-cyan-500 bg-clip-text text-transparent">송금 통화 비교 계산기</h1>
        <p class="text-slate-600 mt-1">은행 고시 vs 실시간 환율 · 금액/설정 저장 · 초기화 · 내보내기</p>
      </div>
      <div class="flex items-center gap-2 text-xs md:text-sm">
        <span id="sourceBadge" class="chip">소스: -</span>
        <span id="lastUpdate" class="chip">업데이트: -</span>
        <span id="lastSaved" class="chip">저장: -</span>
      </div>
    </header>

    <!-- MODE & CONTROLS -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="card-raise rounded-2xl bg-white border shadow p-5 md:col-span-2">
        <h2 class="font-semibold text-slate-800 mb-2">모드 선택</h2>
        <div class="grid sm:grid-cols-2 gap-3">
          <label class="flex items-center gap-3 p-3 rounded-xl border cursor-pointer hover:bg-slate-50">
            <input type="radio" name="mode" id="modeBank" class="accent-indigo-600" checked>
            <div>
              <div class="font-semibold">은행 고시 모드 (송금보낼때)</div>
              <div class="text-xs text-slate-500">입력한 고시 환율을 그대로 사용 — 실제 송금액 근접</div>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 rounded-xl border cursor-pointer hover:bg-slate-50">
            <input type="radio" name="mode" id="modeLive" class="accent-indigo-600">
            <div>
              <div class="font-semibold">실시간 환율 모드 (중앙값 + 마진)</div>
              <div class="text-xs text-slate-500">exchangerate.host → ER‑API → frankfurter 순으로 조회</div>
            </div>
          </label>
        </div>
        <div class="mt-4 flex items-center gap-3">
          <label class="text-sm text-slate-600">마진(실시간 모드)</label>
          <input id="marginInput" type="number" step="0.1" min="0" value="2" class="w-24 rounded-lg border px-3 py-2 text-right">
          <span class="text-xs text-slate-500">%</span>
          <label class="ml-4 flex items-center gap-2 text-sm px-3 py-2 rounded-xl bg-white shadow-sm border">
            <input id="autoRefresh" type="checkbox" class="scale-110 accent-indigo-600">
            3분마다 자동 갱신
          </label>
        </div>
      </div>
      <div class="card-raise rounded-2xl bg-white border shadow p-5 flex flex-col gap-2">
        <button id="saveAll" class="w-full rounded-lg bg-indigo-600 text-white py-2 font-semibold">모든 값 저장</button>
        <div class="grid grid-cols-2 gap-2">
          <button id="resetAmounts" class="rounded-lg bg-amber-100 text-amber-800 py-2 font-semibold">금액 초기화</button>
          <button id="resetAll" class="rounded-lg bg-rose-100 text-rose-800 py-2 font-semibold">전체 초기화</button>
        </div>
        <button id="exportBtn" class="w-full rounded-lg bg-slate-800 text-white py-2 font-semibold">내보내기(JSON 복사)</button>
        <button id="importBtn" class="w-full rounded-lg bg-slate-200 text-slate-800 py-2 font-semibold">가져오기(JSON 붙여넣기)</button>
      </div>
    </section>

    <!-- BANK INPUTS -->
    <section class="rounded-2xl bg-white border shadow p-5 mb-6" id="bankInputs">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-bold text-slate-800">은행 고시 — 송금보낼때</h2>
        <span class="text-xs text-slate-500">고시완료 시각 기준 입력</span>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div>
          <label class="block text-xs text-slate-600 mb-1">USD (₩/1 USD)</label>
          <input id="usdBank" type="number" step="0.01" value="1415.90" class="w-full rounded-lg border px-3 py-2" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">JPY (기준: 100엔)</label>
          <input id="jpyBank" type="number" step="0.01" value="950.98" class="w-full rounded-lg border px-3 py-2" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">EUR (₩/1 EUR)</label>
          <input id="eurBank" type="number" step="0.01" value="1660.31" class="w-full rounded-lg border px-3 py-2" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">CNY (₩/1 CNY)</label>
          <input id="cnyBank" type="number" step="0.01" value="198.85" class="w-full rounded-lg border px-3 py-2" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">CAD (₩/1 CAD)</label>
          <input id="cadBank" type="number" step="0.01" placeholder="예: 1,0xx" class="w-full rounded-lg border px-3 py-2" />
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-2">※ 저장 시 은행 고시 값과 모드/마진/견적 금액이 로컬에 저장됩니다.</p>
    </section>

    <!-- LIVE RATES (read-only) -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="liveCards" style="display:none">
      <div class="card-raise rounded-2xl bg-white border shadow p-5"><div class="text-slate-500 text-sm">USD (실시간+마진)</div><div id="usdLive" class="num text-2xl font-extrabold text-indigo-700">-</div></div>
      <div class="card-raise rounded-2xl bg-white border shadow p-5"><div class="text-slate-500 text-sm">CNY (실시간+마진)</div><div id="cnyLive" class="num text-2xl font-extrabold text-cyan-700">-</div></div>
      <div class="card-raise rounded-2xl bg-white border shadow p-5"><div class="text-slate-500 text-sm">CAD (실시간+마진)</div><div id="cadLive" class="num text-2xl font-extrabold text-teal-700">-</div></div>
      <div class="card-raise rounded-2xl bg-white border shadow p-5"><div class="text-slate-500 text-sm">EUR/JPY (실시간+마진)</div><div id="eurjpyLive" class="num text-xl font-extrabold text-slate-700">-</div></div>
    </section>

    <!-- QUOTES (AMOUNTS) -->
    <section class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
      <div class="rounded-2xl bg-white border shadow p-5">
        <label class="block text-sm text-slate-600 mb-2">USD 견적</label>
        <input id="usdAmt" type="number" inputmode="decimal" placeholder="0.00" class="w-full rounded-lg border px-3 py-2" />
        <div class="mt-2 text-xs text-slate-500">원화 환산</div>
        <div id="usdKrw" class="num text-xl font-bold text-indigo-700">-</div>
      </div>
      <div class="rounded-2xl bg-white border shadow p-5">
        <label class="block text-sm text-slate-600 mb-2">CNY 견적</label>
        <input id="cnyAmt" type="number" inputmode="decimal" placeholder="0.00" class="w-full rounded-lg border px-3 py-2" />
        <div class="mt-2 text-xs text-slate-500">원화 환산</div>
        <div id="cnyKrw" class="num text-xl font-bold text-cyan-700">-</div>
      </div>
      <div class="rounded-2xl bg-white border shadow p-5">
        <label class="block text-sm text-slate-600 mb-2">CAD 견적</label>
        <input id="cadAmt" type="number" inputmode="decimal" placeholder="0.00" class="w-full rounded-lg border px-3 py-2" />
        <div class="mt-2 text-xs text-slate-500">원화 환산</div>
        <div id="cadKrw" class="num text-xl font-bold text-teal-700">-</div>
      </div>
      <div class="rounded-2xl bg-white border shadow p-5">
        <label class="block text-sm text-slate-600 mb-2">EUR 견적</label>
        <input id="eurAmt" type="number" inputmode="decimal" placeholder="0.00" class="w-full rounded-lg border px-3 py-2" />
        <div class="mt-2 text-xs text-slate-500">원화 환산</div>
        <div id="eurKrw" class="num text-xl font-bold text-slate-700">-</div>
      </div>
      <div class="rounded-2xl bg-white border shadow p-5">
        <label class="block text-sm text-slate-600 mb-2">JPY 견적</label>
        <div class="flex gap-2">
          <select id="jpyQuoteUnit" class="rounded-lg border px-3 py-2">
            <option value="1">JPY</option>
            <option value="100" selected>100 JPY</option>
          </select>
          <input id="jpyAmt" type="number" inputmode="decimal" placeholder="0.00" class="w-full rounded-lg border px-3 py-2" />
        </div>
        <div class="mt-2 text-xs text-slate-500">원화 환산</div>
        <div id="jpyKrw" class="num text-xl font-bold text-rose-700">-</div>
      </div>
    </section>

    <!-- RESULT -->
    <section id="resultWrap" class="hidden rounded-2xl bg-white border shadow p-6 mb-10">
      <div class="flex items-center gap-2 mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
        <h2 class="text-xl font-bold text-slate-800">송금 통화 비교 결과</h2>
      </div>
      <div id="comparisonList" class="space-y-3"></div>
      <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="rounded-xl border bg-emerald-50 text-emerald-800 p-4"><div class="text-xs">최저가 통화</div><div id="cheapest" class="text-2xl font-extrabold">-</div></div>
        <div class="rounded-xl border bg-amber-50 text-amber-800 p-4"><div class="text-xs">최고가 대비 추가 비용</div><div id="extraCost" class="text-2xl font-extrabold">-</div></div>
        <div class="rounded-xl border bg-indigo-50 text-indigo-800 p-4"><div class="text-xs">최대 절감 가능 금액</div><div id="maxSave" class="text-2xl font-extrabold">-</div></div>
      </div>
    </section>

    <footer class="text-center text-xs text-slate-500">※ 저장은 이 브라우저/기기에서만 유효합니다. 실시간 모드 환율은 중앙값에 마진(기본 2%) 반영.</footer>
  </div>

  <script>
    /* ===== LocalStorage Keys ===== */
    const LS_KEYS = {
      SETTINGS: 'fxcalc_v1_settings', // mode, margin, ratesBank
      AMOUNTS: 'fxcalc_v1_amounts',   // USD,CNY,CAD,EUR,JPY,jpyQuoteUnit
    };

    /* ===== State ===== */
    const state = {
      mode: 'bank',
      marginPct: 2,
      ratesBank: { USD: 1415.90, CNY: 198.85, EUR: 1660.31, JPY_100: 950.98, CAD: NaN },
      ratesLive: { USD: 0, CNY: 0, CAD: 0, EUR: 0, JPY: 0 },
      amounts: { USD: '', CNY: '', CAD: '', EUR: '', JPY: '', jpyUnit: 100 },
      autoTimer: null,
    };

    /* ===== DOM Shortcuts ===== */
    const $ = (id) => document.getElementById(id);
    const fmtWon = (n) => '₩' + Math.round(n).toLocaleString();
    const fmtRate = (n) => '₩' + Math.round(n).toLocaleString();

    /* ===== Load Saved Data ===== */
    function loadAll(){
      try{
        const s = JSON.parse(localStorage.getItem(LS_KEYS.SETTINGS) || 'null');
        if(s){
          state.mode = s.mode ?? state.mode;
          state.marginPct = s.marginPct ?? state.marginPct;
          if(s.ratesBank){
            state.ratesBank = { ...state.ratesBank, ...s.ratesBank };
          }
          $('marginInput').value = state.marginPct;
          $('usdBank').value = Number(state.ratesBank.USD || '');
          $('cnyBank').value = Number(state.ratesBank.CNY || '');
          $('eurBank').value = Number(state.ratesBank.EUR || '');
          $('jpyBank').value = Number(state.ratesBank.JPY_100 || '');
          $('cadBank').value = state.ratesBank.CAD || '';
          if(state.mode==='live'){ $('modeLive').checked=true; } else { $('modeBank').checked=true; }
          switchMode(state.mode);
          if(s.savedAt){ $('lastSaved').textContent = '저장: ' + new Date(s.savedAt).toLocaleString('ko-KR'); }
        }
        const a = JSON.parse(localStorage.getItem(LS_KEYS.AMOUNTS) || 'null');
        if(a){
          state.amounts = { ...state.amounts, ...a };
          $('usdAmt').value = a.USD || '';
          $('cnyAmt').value = a.CNY || '';
          $('cadAmt').value = a.CAD || '';
          $('eurAmt').value = a.EUR || '';
          $('jpyAmt').value = a.JPY || '';
          $('jpyQuoteUnit').value = a.jpyUnit || 100;
        }
      }catch(e){ console.warn('loadAll failed', e); }
    }

    /* ===== Save & Reset ===== */
    function saveAll(){
      const settings = {
        mode: state.mode,
        marginPct: Number($('marginInput').value||state.marginPct),
        ratesBank: {
          USD: parseFloat($('usdBank').value)||NaN,
          CNY: parseFloat($('cnyBank').value)||NaN,
          EUR: parseFloat($('eurBank').value)||NaN,
          JPY_100: parseFloat($('jpyBank').value)||NaN,
          CAD: parseFloat($('cadBank').value)||NaN,
        },
        savedAt: Date.now(),
      };
      state.marginPct = settings.marginPct;
      state.ratesBank = settings.ratesBank;

      const amounts = {
        USD: $('usdAmt').value || '',
        CNY: $('cnyAmt').value || '',
        CAD: $('cadAmt').value || '',
        EUR: $('eurAmt').value || '',
        JPY: $('jpyAmt').value || '',
        jpyUnit: Number($('jpyQuoteUnit').value)||100,
      };
      state.amounts = amounts;

      localStorage.setItem(LS_KEYS.SETTINGS, JSON.stringify(settings));
      localStorage.setItem(LS_KEYS.AMOUNTS, JSON.stringify(amounts));
      $('lastSaved').textContent = '저장: ' + new Date(settings.savedAt).toLocaleString('ko-KR');
      alert('모든 값이 저장되었습니다. (이 브라우저/기기 전용)');
      recalc();
    }

    function resetAmounts(){
      state.amounts = { USD:'',CNY:'',CAD:'',EUR:'',JPY:'', jpyUnit:100 };
      ['usdAmt','cnyAmt','cadAmt','eurAmt','jpyAmt'].forEach(id=> $(id).value='');
      $('jpyQuoteUnit').value = 100;
      localStorage.removeItem(LS_KEYS.AMOUNTS);
      recalc();
    }

    function resetAll(){
      if(!confirm('모든 저장값(고시/모드/마진/금액)을 초기화할까요?')) return;
      localStorage.removeItem(LS_KEYS.SETTINGS);
      localStorage.removeItem(LS_KEYS.AMOUNTS);
      location.reload();
    }

    function exportJSON(){
      const payload = {
        settings: JSON.parse(localStorage.getItem(LS_KEYS.SETTINGS) || 'null'),
        amounts: JSON.parse(localStorage.getItem(LS_KEYS.AMOUNTS) || 'null'),
      };
      const str = JSON.stringify(payload, null, 2);
      navigator.clipboard.writeText(str).then(()=> alert('JSON이 클립보드로 복사되었습니다.'));
    }

    function importJSON(){
      const str = prompt('여기에 JSON을 붙여넣으세요');
      if(!str) return;
      try{
        const obj = JSON.parse(str);
        if(obj.settings) localStorage.setItem(LS_KEYS.SETTINGS, JSON.stringify(obj.settings));
        if(obj.amounts) localStorage.setItem(LS_KEYS.AMOUNTS, JSON.stringify(obj.amounts));
        alert('가져오기가 완료되었습니다. 페이지를 다시 불러옵니다.');
        location.reload();
      }catch(e){ alert('유효한 JSON이 아닙니다.'); }
    }

    /* ===== Mode Switch & Live Rates ===== */
    function switchMode(mode){
      state.mode = mode;
      if(mode==='bank'){
        $('bankInputs').style.display='block';
        $('liveCards').style.display='none';
        $('sourceBadge').textContent = '소스: 은행 고시(송금보낼때)';
        $('lastUpdate').textContent = '업데이트: 사용자 입력';
        if(state.autoTimer){ clearInterval(state.autoTimer); state.autoTimer=null; }
        recalc();
      }else{
        $('bankInputs').style.display='none';
        $('liveCards').style.display='grid';
        fetchLiveRates();
        if(state.autoTimer) clearInterval(state.autoTimer);
        if($('autoRefresh').checked){ state.autoTimer = setInterval(fetchLiveRates, 180000); }
      }
    }

    const providers = [
      async (signal) => { const u=`https://api.exchangerate.host/latest?base=KRW&symbols=USD,CNY,CAD,EUR,JPY&_=${Date.now()}`; const r=await fetch(u,{signal,cache:'no-store'}); if(!r.ok) throw new Error('exchangerate.host'); const d=await r.json(); return {provider:'exchangerate.host', rates:d.rates}; },
      async (signal) => { const u=`https://open.er-api.com/v6/latest/KRW?_=${Date.now()}`; const r=await fetch(u,{signal,cache:'no-store'}); if(!r.ok) throw new Error('open.er-api'); const d=await r.json(); if(d.result!=='success') throw new Error('erapi-bad'); return {provider:'open.er-api.com', rates:d.rates}; },
      async (signal) => { const u=`https://api.frankfurter.app/latest?from=KRW&to=USD,CNY,CAD,EUR,JPY&_=${Date.now()}`; const r=await fetch(u,{signal,cache:'no-store'}); if(!r.ok) throw new Error('frankfurter'); const d=await r.json(); return {provider:'frankfurter.app', rates:d.rates}; },
    ];

    const withTimeout = (fn, ms) => new Promise((resolve,reject)=>{ const t=setTimeout(()=>reject(new Error('timeout')),ms); fn().then(v=>{clearTimeout(t);resolve(v)}).catch(e=>{clearTimeout(t);reject(e)}); });

    async function fetchLiveRates(){
      let lastErr=null; const controller=new AbortController(); const m=1+(Number($('marginInput').value||state.marginPct)/100);
      for(const p of providers){
        try{
          const payload = await withTimeout(()=>p(controller.signal), 7000);
          const inv = (x)=> x>0 ? 1/x : NaN;
          state.ratesLive = {
            USD: Math.round(inv(payload.rates.USD) * m),
            CNY: Math.round(inv(payload.rates.CNY) * m),
            CAD: Math.round(inv(payload.rates.CAD) * m),
            EUR: Math.round(inv(payload.rates.EUR) * m),
            JPY: Math.round(inv(payload.rates.JPY) * m),
          };
          $('usdLive').textContent = fmtRate(state.ratesLive.USD);
          $('cnyLive').textContent = fmtRate(state.ratesLive.CNY);
          $('cadLive').textContent = isFinite(state.ratesLive.CAD) ? fmtRate(state.ratesLive.CAD) : '-';
          $('eurjpyLive').textContent = `EUR ${fmtRate(state.ratesLive.EUR)} / JPY ${fmtRate(state.ratesLive.JPY)}`;
          $('sourceBadge').textContent = `소스: ${payload.provider} + 마진 ${Number($('marginInput').value||state.marginPct)}%`;
          $('lastUpdate').textContent = '업데이트: ' + new Date().toLocaleString('ko-KR');
          recalc();
          return;
        }catch(e){ lastErr=e; }
      }
      console.error('live FX failed', lastErr);
      $('sourceBadge').textContent = '소스: live 실패 — 은행 고시 사용 권장';
    }

    /* ===== Calculation ===== */
    function getActiveRate(cur){
      if(state.mode==='bank'){
        if(cur==='JPY') return (Number($('jpyBank').value)||0) / 100; // per 1 JPY
        return parseFloat({USD:$('usdBank').value, CNY:$('cnyBank').value, CAD:$('cadBank').value, EUR:$('eurBank').value}[cur]) || NaN;
      }
      return {USD:state.ratesLive.USD, CNY:state.ratesLive.CNY, CAD:state.ratesLive.CAD, EUR:state.ratesLive.EUR, JPY:state.ratesLive.JPY}[cur];
    }

    function recalc(){
      const a = {
        USD: parseFloat($('usdAmt').value)||0,
        CNY: parseFloat($('cnyAmt').value)||0,
        CAD: parseFloat($('cadAmt').value)||0,
        EUR: parseFloat($('eurAmt').value)||0,
        JPY: parseFloat($('jpyAmt').value)||0,
        jpyUnit: Number($('jpyQuoteUnit').value)||100,
      };
      const r = {
        USD: getActiveRate('USD'),
        CNY: getActiveRate('CNY'),
        CAD: getActiveRate('CAD'),
        EUR: getActiveRate('EUR'),
        JPY: getActiveRate('JPY'), // per 1 JPY
      };

      const won = {
        USD: a.USD && isFinite(r.USD) ? a.USD * r.USD : 0,
        CNY: a.CNY && isFinite(r.CNY) ? a.CNY * r.CNY : 0,
        CAD: a.CAD && isFinite(r.CAD) ? a.CAD * r.CAD : 0,
        EUR: a.EUR && isFinite(r.EUR) ? a.EUR * r.EUR : 0,
        JPY: a.JPY && isFinite(r.JPY) ? (a.JPY * (a.jpyUnit===100?100:1)) * r.JPY : 0,
      };

      $('usdKrw').textContent = won.USD ? fmtWon(won.USD) : '-';
      $('cnyKrw').textContent = won.CNY ? fmtWon(won.CNY) : '-';
      $('cadKrw').textContent = won.CAD ? fmtWon(won.CAD) : '-';
      $('eurKrw').textContent = won.EUR ? fmtWon(won.EUR) : '-';
      $('jpyKrw').textContent = won.JPY ? fmtWon(won.JPY) : '-';

      const items = [
        { label:'USD', val:won.USD, color:'text-indigo-700', bar:'bg-indigo-200' },
        { label:'CNY', val:won.CNY, color:'text-cyan-700', bar:'bg-cyan-200' },
        { label:'CAD', val:won.CAD, color:'text-teal-700', bar:'bg-teal-200' },
        { label:'EUR', val:won.EUR, color:'text-slate-700', bar:'bg-slate-200' },
        { label:'JPY', val:won.JPY, color:'text-rose-700', bar:'bg-rose-200' },
      ].filter(x=>x.val>0).sort((a,b)=>a.val-b.val);

      const wrap = $('resultWrap');
      const list = $('comparisonList');
      if(items.length>=2){
        wrap.classList.remove('hidden');
        list.innerHTML='';
        const min=items[0].val, max=items[items.length-1].val;
        items.forEach((it,idx)=>{
          const pct = max>0? Math.round((it.val/max)*100) : 0;
          const row = document.createElement('div');
          row.className='rounded-xl border p-4';
          row.innerHTML=`<div class='flex items-center justify-between mb-2'><div class='text-sm text-slate-600'>${idx+1}. ${it.label}</div><div class='text-lg font-bold ${it.color}'>${fmtWon(it.val)}</div></div><div class='w-full h-2 rounded-full bg-slate-100 overflow-hidden'><div class='h-2 ${it.bar}' style='width:${pct}%;'></div></div>`;
          list.appendChild(row);
        });
        $('cheapest').textContent = items[0].label;
        $('extraCost').textContent = fmtWon(max - min);
        $('maxSave').textContent = fmtWon(max - min);
      }else{
        wrap.classList.add('hidden');
      }
    }

    /* ===== Wire Events ===== */
    function bindEvents(){
      $('modeBank').addEventListener('change', ()=> $('modeBank').checked && switchMode('bank'));
      $('modeLive').addEventListener('change', ()=> $('modeLive').checked && switchMode('live'));
      $('marginInput').addEventListener('input', ()=> state.mode==='live' && fetchLiveRates());
      $('autoRefresh').addEventListener('change', ()=>{ if(state.mode==='live'){ if($('autoRefresh').checked){ state.autoTimer=setInterval(fetchLiveRates,180000);} else if(state.autoTimer){clearInterval(state.autoTimer); state.autoTimer=null;} } });

      // bank fields update preview
      ['usdBank','cnyBank','cadBank','eurBank','jpyBank'].forEach(id=> $(id).addEventListener('input', ()=> state.mode==='bank' && recalc()));

      // amounts
      ['usdAmt','cnyAmt','cadAmt','eurAmt','jpyAmt','jpyQuoteUnit'].forEach(id=> $(id).addEventListener('input', recalc));

      $('saveAll').addEventListener('click', saveAll);
      $('resetAmounts').addEventListener('click', resetAmounts);
      $('resetAll').addEventListener('click', resetAll);
      $('exportBtn').addEventListener('click', exportJSON);
      $('importBtn').addEventListener('click', importJSON);
    }

    /* ===== Init ===== */
    loadAll();
    bindEvents();
    if(state.mode==='bank') switchMode('bank'); else switchMode('live');
    recalc();
  </script>
</body>
</html>
