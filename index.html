<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>송금 통화 비교 계산기 — Bank/Live 모드</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card-raise{transition:transform .2s ease,box-shadow .2s ease}
    .card-raise:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.12)}
    .odometer{font-variant-numeric:tabular-nums}
    .chip{border-radius:9999px;padding:.2rem .6rem;border:1px solid rgba(0,0,0,.08);background:#fff}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-sky-50 to-cyan-50">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <!-- HEADER -->
    <header class="flex flex-col md:flex-row gap-4 md:items-center md:justify-between mb-6">
      <div>
        <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight bg-gradient-to-r from-indigo-600 to-cyan-500 bg-clip-text text-transparent">송금 통화 비교 계산기</h1>
        <p class="text-slate-600 mt-1">은행 고시(송금보낼때) vs 실시간 환율(중앙값+마진) — 차이를 정확히 반영</p>
      </div>
      <div class="flex items-center gap-3">
        <div class="chip text-xs" id="lastUpdate">업데이트: -</div>
        <div class="chip text-xs" id="sourceBadge">소스: -</div>
      </div>
    </header>

    <!-- MODE SWITCH -->
    <section class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card-raise rounded-2xl bg-white border shadow p-5 md:col-span-2">
        <label class="text-sm text-slate-600">모드 선택</label>
        <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-3">
          <label class="flex items-center gap-3 p-3 rounded-xl border cursor-pointer hover:bg-slate-50">
            <input type="radio" name="mode" id="modeBank" class="accent-indigo-600" checked>
            <div>
              <div class="font-semibold">은행 고시 모드 (송금보낼때)</div>
              <div class="text-xs text-slate-500">직접 입력한 고시 환율을 그대로 사용 — 가장 보수적이고 실제 송금액에 근접</div>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 rounded-xl border cursor-pointer hover:bg-slate-50">
            <input type="radio" name="mode" id="modeLive" class="accent-indigo-600">
            <div>
              <div class="font-semibold">실시간 환율 모드 (중앙값 + 마진)</div>
              <div class="text-xs text-slate-500">exchangerate.host → ER‑API → frankfurter 순으로 조회 후 마진(기본 2%) 적용</div>
            </div>
          </label>
        </div>
      </div>
      <div class="card-raise rounded-2xl bg-white border shadow p-5">
        <label class="text-sm text-slate-600">송금 마진(실시간 모드)</label>
        <div class="mt-2 flex items-center gap-3">
          <input id="marginInput" type="number" step="0.1" min="0" value="2" class="w-24 rounded-lg border px-3 py-2 text-right">
          <span class="text-sm text-slate-500">%</span>
        </div>
        <p class="text-xs text-slate-400 mt-2">은행 고시 모드에서는 무시됩니다.</p>
      </div>
    </section>

    <!-- BANK INPUTS -->
    <section class="rounded-2xl bg-white border shadow p-5 mb-6" id="bankInputs">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-bold text-slate-800">은행 고시 — 송금보낼때</h2>
        <span class="text-xs text-slate-500">고시완료 시각 기준 입력</span>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div>
          <label class="block text-xs text-slate-600 mb-1">USD (1 USD 당 ₩)</label>
          <input id="usdBank" type="number" step="0.01" value="1415.90" class="w-full rounded-lg border px-3 py-2" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">JPY (단위 선택)</label>
          <div class="flex gap-2">
            <select id="jpyUnit" class="rounded-lg border px-3 py-2">
              <option value="100" selected>100 JPY 기준</option>
              <option value="1">1 JPY 기준</option>
            </select>
            <input id="jpyBank" type="number" step="0.01" value="950.98" class="w-full rounded-lg border px-3 py-2" />
          </div>
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">EUR (1 EUR 당 ₩)</label>
          <input id="eurBank" type="number" step="0.01" value="1660.31" class="w-full rounded-lg border px-3 py-2" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">CNY (1 CNY 당 ₩)</label>
          <input id="cnyBank" type="number" step="0.01" value="198.85" class="w-full rounded-lg border px-3 py-2" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">CAD (1 CAD 당 ₩)</label>
          <input id="cadBank" type="number" step="0.01" placeholder="예: 1,0xx" class="w-full rounded-lg border px-3 py-2" />
        </div>
      </div>
      <p class="text-xs text-slate-500 mt-2">※ 입력하지 않은 통화는 결과 계산에 포함되지 않습니다.</p>
    </section>

    <!-- LIVE RATES (read-only cards) -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="liveCards" style="display:none">
      <div class="card-raise rounded-2xl bg-white border shadow p-5">
        <div class="text-slate-500 text-sm">USD (실시간+마진)</div>
        <div id="usdLive" class="odometer text-2xl font-extrabold text-indigo-700">-</div>
      </div>
      <div class="card-raise rounded-2xl bg-white border shadow p-5">
        <div class="text-slate-500 text-sm">CNY (실시간+마진)</div>
        <div id="cnyLive" class="odometer text-2xl font-extrabold text-cyan-700">-</div>
      </div>
      <div class="card-raise rounded-2xl bg-white border shadow p-5">
        <div class="text-slate-500 text-sm">CAD (실시간+마진)</div>
        <div id="cadLive" class="odometer text-2xl font-extrabold text-teal-700">-</div>
      </div>
      <div class="card-raise rounded-2xl bg-white border shadow p-5">
        <div class="text-slate-500 text-sm">EUR/JPY (실시간+마진)</div>
        <div id="eurjpyLive" class="odometer text-2xl font-extrabold text-slate-700">-</div>
      </div>
    </section>

    <!-- QUOTES INPUTS -->
    <section class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
      <div class="rounded-2xl bg-white border shadow p-5">
        <label class="block text-sm text-slate-600 mb-2">USD 견적</label>
        <input id="usdAmt" type="number" inputmode="decimal" placeholder="0.00" class="w-full rounded-lg border px-3 py-2" />
        <div class="mt-2 text-xs text-slate-500">원화 환산</div>
        <div id="usdKrw" class="text-xl font-bold text-indigo-700">-</div>
      </div>
      <div class="rounded-2xl bg-white border shadow p-5">
        <label class="block text-sm text-slate-600 mb-2">CNY 견적</label>
        <input id="cnyAmt" type="number" inputmode="decimal" placeholder="0.00" class="w-full rounded-lg border px-3 py-2" />
        <div class="mt-2 text-xs text-slate-500">원화 환산</div>
        <div id="cnyKrw" class="text-xl font-bold text-cyan-700">-</div>
      </div>
      <div class="rounded-2xl bg-white border shadow p-5">
        <label class="block text-sm text-slate-600 mb-2">CAD 견적</label>
        <input id="cadAmt" type="number" inputmode="decimal" placeholder="0.00" class="w-full rounded-lg border px-3 py-2" />
        <div class="mt-2 text-xs text-slate-500">원화 환산</div>
        <div id="cadKrw" class="text-xl font-bold text-teal-700">-</div>
      </div>
      <div class="rounded-2xl bg-white border shadow p-5">
        <label class="block text-sm text-slate-600 mb-2">EUR 견적</label>
        <input id="eurAmt" type="number" inputmode="decimal" placeholder="0.00" class="w-full rounded-lg border px-3 py-2" />
        <div class="mt-2 text-xs text-slate-500">원화 환산</div>
        <div id="eurKrw" class="text-xl font-bold text-slate-700">-</div>
      </div>
      <div class="rounded-2xl bg-white border shadow p-5">
        <label class="block text-sm text-slate-600 mb-2">JPY 견적</label>
        <div class="flex gap-2">
          <select id="jpyQuoteUnit" class="rounded-lg border px-3 py-2">
            <option value="1">JPY</option>
            <option value="100" selected>100 JPY</option>
          </select>
          <input id="jpyAmt" type="number" inputmode="decimal" placeholder="0.00" class="w-full rounded-lg border px-3 py-2" />
        </div>
        <div class="mt-2 text-xs text-slate-500">원화 환산</div>
        <div id="jpyKrw" class="text-xl font-bold text-rose-700">-</div>
      </div>
    </section>

    <!-- RESULT -->
    <section id="resultWrap" class="hidden rounded-2xl bg-white border shadow p-6 mb-10">
      <div class="flex items-center gap-2 mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
        <h2 class="text-xl font-bold text-slate-800">송금 통화 비교 결과</h2>
      </div>
      <div id="comparisonList" class="space-y-3"></div>
      <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="rounded-xl border bg-emerald-50 text-emerald-800 p-4">
          <div class="text-xs">최저가 통화</div>
          <div id="cheapest" class="text-2xl font-extrabold">-</div>
        </div>
        <div class="rounded-xl border bg-amber-50 text-amber-800 p-4">
          <div class="text-xs">최고가 대비 추가 비용</div>
          <div id="extraCost" class="text-2xl font-extrabold">-</div>
        </div>
        <div class="rounded-xl border bg-indigo-50 text-indigo-800 p-4">
          <div class="text-xs">최대 절감 가능 금액</div>
          <div id="maxSave" class="text-2xl font-extrabold">-</div>
        </div>
      </div>
    </section>

    <footer class="text-center text-xs text-slate-500">※ 은행 고시 모드는 입력값 그대로 사용합니다. 실시간 모드는 중앙값에 마진(기본 2%)을 반영합니다.</footer>
  </div>

  <script>
    /* ===== Config & State ===== */
    const REFRESH_MS = 180000; // live mode auto-refresh (3m)
    const TIMEOUT_MS = 7000;
    let autoTimer = null;

    const state = {
      mode: 'bank', // 'bank' | 'live'
      marginPct: 2,
      ratesBank: { USD: 1415.90, CNY: 198.85, EUR: 1660.31, JPY: 950.98, JPY_UNIT: 100, CAD: NaN },
      ratesLive: { USD: 0, CNY: 0, CAD: 0, EUR: 0, JPY: 0, JPY_UNIT: 1 },
    };

    const q = (id) => document.getElementById(id);
    const fmtWon = (n) => '₩' + Math.round(n).toLocaleString();
    const fmtRate = (n) => '₩' + (Math.round(n)).toLocaleString();

    /* ===== Mode & Inputs ===== */
    q('modeBank').addEventListener('change', () => { if (q('modeBank').checked) switchMode('bank'); });
    q('modeLive').addEventListener('change', () => { if (q('modeLive').checked) switchMode('live'); });
    q('marginInput').addEventListener('input', () => { state.marginPct = Math.max(0, Number(q('marginInput').value||0)); if (state.mode==='live') fetchLiveRates(); });

    // Bank inputs
    q('usdBank').addEventListener('input', () => state.ratesBank.USD = parseFloat(q('usdBank').value)||NaN);
    q('cnyBank').addEventListener('input', () => state.ratesBank.CNY = parseFloat(q('cnyBank').value)||NaN);
    q('eurBank').addEventListener('input', () => state.ratesBank.EUR = parseFloat(q('eurBank').value)||NaN);
    q('cadBank').addEventListener('input', () => state.ratesBank.CAD = parseFloat(q('cadBank').value)||NaN);
    q('jpyUnit').addEventListener('change', () => { state.ratesBank.JPY_UNIT = Number(q('jpyUnit').value); recalc(); });
    q('jpyBank').addEventListener('input', () => { state.ratesBank.JPY = parseFloat(q('jpyBank').value)||NaN; recalc(); });

    // Quote inputs
    ['usdAmt','cnyAmt','cadAmt','eurAmt','jpyAmt','jpyQuoteUnit'].forEach(id => q(id).addEventListener('input', recalc));

    function switchMode(mode){
      state.mode = mode;
      if(mode==='bank'){
        q('bankInputs').style.display='block';
        q('liveCards').style.display='none';
        q('sourceBadge').textContent = '소스: 은행 고시(송금보낼때)';
        q('lastUpdate').textContent = `업데이트: 사용자 입력`;
        if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
        recalc();
      } else {
        q('bankInputs').style.display='none';
        q('liveCards').style.display='grid';
        fetchLiveRates();
        if (autoTimer) clearInterval(autoTimer);
        autoTimer = setInterval(fetchLiveRates, REFRESH_MS);
      }
    }

    /* ===== Live Rates ===== */
    const withTimeout = (fn, ms) => new Promise((resolve, reject)=>{
      const t = setTimeout(()=>reject(new Error('timeout')), ms);
      fn().then(v=>{clearTimeout(t); resolve(v);}).catch(e=>{clearTimeout(t); reject(e);});
    });

    const providers = [
      async (signal) => {
        const u = `https://api.exchangerate.host/latest?base=KRW&symbols=USD,CNY,CAD,EUR,JPY&_=${Date.now()}`;
        const r = await fetch(u, { signal, cache: 'no-store' }); if(!r.ok) throw new Error('exchangerate.host');
        const d = await r.json(); return {provider:'exchangerate.host', rates:d.rates};
      },
      async (signal) => {
        const u = `https://open.er-api.com/v6/latest/KRW?_=${Date.now()}`;
        const r = await fetch(u, { signal, cache: 'no-store' }); if(!r.ok) throw new Error('open.er-api');
        const d = await r.json(); if(d.result!=='success') throw new Error('erapi-bad');
        return {provider:'open.er-api.com', rates:d.rates};
      },
      async (signal) => {
        const u = `https://api.frankfurter.app/latest?from=KRW&to=USD,CNY,CAD,EUR,JPY&_=${Date.now()}`;
        const r = await fetch(u, { signal, cache: 'no-store' }); if(!r.ok) throw new Error('frankfurter');
        const d = await r.json(); return {provider:'frankfurter.app', rates:d.rates};
      }
    ];

    async function fetchLiveRates(){
      let lastErr = null; const controller = new AbortController();
      for(const p of providers){
        try{
          const payload = await withTimeout(()=>p(controller.signal), TIMEOUT_MS);
          const m = 1 + (state.marginPct/100);
          // providers give TARGET per 1 KRW → invert to KRW per 1 TARGET
          const inv = (x)=> x>0? 1/x : NaN;
          state.ratesLive = {
            USD: Math.round(inv(payload.rates.USD) * m),
            CNY: Math.round(inv(payload.rates.CNY) * m),
            CAD: Math.round(inv(payload.rates.CAD) * m),
            EUR: Math.round(inv(payload.rates.EUR) * m),
            JPY: Math.round(inv(payload.rates.JPY) * m),
            JPY_UNIT: 1,
          };
          q('usdLive').textContent = fmtRate(state.ratesLive.USD);
          q('cnyLive').textContent = fmtRate(state.ratesLive.CNY);
          q('cadLive').textContent = isFinite(state.ratesLive.CAD)? fmtRate(state.ratesLive.CAD) : '-';
          q('eurjpyLive').textContent = `EUR ${fmtRate(state.ratesLive.EUR)} / JPY ${fmtRate(state.ratesLive.JPY)}`;
          q('sourceBadge').textContent = `소스: ${payload.provider} + 마진 ${state.marginPct}%`;
          q('lastUpdate').textContent = `업데이트: ${new Date().toLocaleString('ko-KR')}`;
          recalc();
          return;
        }catch(e){ lastErr = e; }
      }
      console.error('live FX failed', lastErr);
      q('sourceBadge').textContent = '소스: live 실패 — 은행 고시 사용 권장';
    }

    /* ===== Calculation ===== */
    function getActiveRate(cur){
      if(state.mode==='bank'){
        if(cur==='JPY'){
          const perUnit = state.ratesBank.JPY_UNIT===100 ? (state.ratesBank.JPY/100) : state.ratesBank.JPY;
          return perUnit; // KRW per 1 JPY
        }
        return state.ratesBank[cur];
      }else{
        if(cur==='JPY'){ return state.ratesLive.JPY; }
        return state.ratesLive[cur];
      }
    }

    function recalc(){
      const usdAmt = parseFloat(q('usdAmt').value)||0;
      const cnyAmt = parseFloat(q('cnyAmt').value)||0;
      const cadAmt = parseFloat(q('cadAmt').value)||0;
      const eurAmt = parseFloat(q('eurAmt').value)||0;
      const jpyAmt = parseFloat(q('jpyAmt').value)||0;
      const jpyQuoteUnit = Number(q('jpyQuoteUnit').value)||1; // 1 or 100

      const rUSD = getActiveRate('USD');
      const rCNY = getActiveRate('CNY');
      const rCAD = getActiveRate('CAD');
      const rEUR = getActiveRate('EUR');
      const rJPY = getActiveRate('JPY'); // per 1 JPY

      const usdKrw = usdAmt && isFinite(rUSD) ? usdAmt * rUSD : 0;
      const cnyKrw = cnyAmt && isFinite(rCNY) ? cnyAmt * rCNY : 0;
      const cadKrw = cadAmt && isFinite(rCAD) ? cadAmt * rCAD : 0;
      const eurKrw = eurAmt && isFinite(rEUR) ? eurAmt * rEUR : 0;
      const jpyKrw = jpyAmt && isFinite(rJPY) ? (jpyAmt * (jpyQuoteUnit===100? 100:1)) * rJPY : 0;

      q('usdKrw').textContent = usdKrw? fmtWon(usdKrw) : '-';
      q('cnyKrw').textContent = cnyKrw? fmtWon(cnyKrw) : '-';
      q('cadKrw').textContent = cadKrw? fmtWon(cadKrw) : '-';
      q('eurKrw').textContent = eurKrw? fmtWon(eurKrw) : '-';
      q('jpyKrw').textContent = jpyKrw? fmtWon(jpyKrw) : '-';

      const items = [
        { label:'USD', val: usdKrw, color:'text-indigo-700', bar:'bg-indigo-200' },
        { label:'CNY', val: cnyKrw, color:'text-cyan-700', bar:'bg-cyan-200' },
        { label:'CAD', val: cadKrw, color:'text-teal-700', bar:'bg-teal-200' },
        { label:'EUR', val: eurKrw, color:'text-slate-700', bar:'bg-slate-200' },
        { label:'JPY', val: jpyKrw, color:'text-rose-700', bar:'bg-rose-200' },
      ].filter(x=>x.val>0).sort((a,b)=>a.val-b.val);

      const wrap = q('resultWrap');
      const list = q('comparisonList');
      if(items.length>=2){
        wrap.classList.remove('hidden');
        list.innerHTML='';
        const min=items[0].val, max=items[items.length-1].val;
        items.forEach((it,idx)=>{
          const pct = max>0? Math.round((it.val/max)*100) : 0;
          const row = document.createElement('div');
          row.className='rounded-xl border p-4';
          row.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm text-slate-600">${idx+1}. ${it.label}</div>
              <div class="text-lg font-bold ${it.color}">${fmtWon(it.val)}</div>
            </div>
            <div class="w-full h-2 rounded-full bg-slate-100 overflow-hidden"><div class="h-2 ${it.bar}" style="width:${pct}%;"></div></div>`;
          list.appendChild(row);
        });
        q('cheapest').textContent = items[0].label;
        q('extraCost').textContent = fmtWon(max - min);
        q('maxSave').textContent = fmtWon(max - min);
      }else{
        wrap.classList.add('hidden');
      }
    }

    /* ===== Init ===== */
    switchMode('bank');
    q('lastUpdate').textContent = '업데이트: 사용자 입력';
    q('sourceBadge').textContent = '소스: 은행 고시(송금보낼때)';
    recalc();
  </script>
</body>
</html>
